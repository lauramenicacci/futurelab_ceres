---
title: "merging_datasets"
author: "Laura Menicacci"
date: "2022-11-25"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(countrycode)
```

## Loading datasets

```{r}
eea <- read_csv("C:/Users/laura/OneDrive/Documenti/LAURA/MCC/Policy databases/eea.csv")
iea <- read_csv("C:/Users/laura/OneDrive/Documenti/LAURA/MCC/Policy databases/policies_database_IEA_commasep.csv")
cpd <- read_csv("C:/Users/laura/OneDrive/Documenti/LAURA/MCC/Policy databases/cpd.csv")
unfccc <- read_csv("C:/Users/laura/OneDrive/Documenti/LAURA/MCC/Policy databases/unfccc_final.csv")
```
# check NAs of IEA


# filter all of them with 
```{r}
iea[513,]
```
# prep for each of datasets
```{r}
eea_prep <- eea %>% 
  filter(grepl(c("Energy Supply|Other Sectors"), `Sector(s) affected`)) %>% 
  select(Country, `Name of policy or measure`, Description, `Implementation period start`, `Implementation period finish`, `URL to main reference`) %>% 
  mutate("Country Code" = countrycode(Country, origin = "country.name", destination = "iso3c")) %>% 
  mutate("Indicator database source" == "EEA")

cpd_prep <- cpd %>% 
  select(Country, `Country ISO`, `Policy Title`, `Policy description`, `Date of decision`, `Start date of implementation`, `End date of implementation`,  `Source or references`) %>% 
  mutate("Indicator database source" == "Climate Policy Database")

iea_prep <- iea %>% 
  filter(grepl(c("Power, Heat and Utilities|Power generation|Electricity and heat generation|Combined heat and power"), Sectors)) %>% 
  select(Country, Year, Policy, Description, URL) %>% 
  mutate("Country Code" = countrycode(Country, origin = "country.name", destination = "iso3c")) %>%
  mutate("Indicator database source" == "IEA")
  # mutate("Country Code" = case_when(Country == "European Union" ~ "Country Code" == "EU")) # not working

unfccc_prep <- unfccc %>% 
  select(Country, `Country Code`, `Source NC#`, Year, `Policy Name`, `Policy Description`, Link) %>% 
  mutate("Year: implementation" = NA) %>% 
  mutate("Year: decision" = NA) %>% 
  mutate("Year: end" = NA) %>% 
  mutate("Indicator database source" = "UNFCCC National Communications")
  
```


# Merge 
```{r}

unfccc_cpd <- full_join(unfccc_prep, cpd_prep, by = c("Country", "Country Code" = "Country ISO", "Policy Name" = "Policy Title", "Policy Description" = "Policy description", "Year: implementation" = "Start date of implementation", "Year: decision" = "Date of decision","Year: end" = "End date of implementation",  "Link" = "Source or references", "Indicator database source" ))

unfccc_cpd_eea <- full_join(unfccc_cpd, eea_prep, by = c("Country", "Country Code", "Policy Name" = "Name of policy or measure", "Policy Description" = "Description", "Year: implementation" = "Implementation period start", "Year: end" = "Implementation period finish",  "Link" = "URL to main reference", "Indicator database source"))

unfccc_cpd_eea_iea <- full_join(unfccc_cpd_eea, iea_prep, by = c("Country", "Country Code", "Policy Name" = "Policy", "Policy Description" = "Description", "Year", "Link" = "URL", "Indicator database source"))

```

Questions: 
 1. does it make sense to have an NC column? Maybe better to put such informationin the Indicator source
 2. Still dates are a problem: how do we consider Year of IEA and UNFCCC? According to IEA definition, year = "Year that the policy went into force". - maybe for IEA it's okay to put it in the implementation year. What about UNFCCC though? 
 
```{r}
write.csv(unfccc_cpd_eea_iea,"C:\\Users\\laura\\OneDrive\\Documenti\\LAURA\\MCC\\Policy databases\\ceres_firstversion.csv")
```

# plots
```{r}
ceres <- unfccc_cpd_eea_iea

ceres %>% 
  ggplot(aes(x = Year), fill = "Indicator database source") + geom_bar(stat = "count") +theme_bw()
```

