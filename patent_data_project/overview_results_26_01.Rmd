---
title: "overview_results"
author: "Laura Menicacci"
date: "2024-01-26"
output: html_document
---

Thoughts: why not the first 30 or first 31 or first 32 or first 33?? I think the choice of the top 25 is a bit arbitrary --> because they cover more than 90% --> but we can arrive to 90 percent using a range of different countries... are these the more important? YES BECAUSE THEY ARE THE MOST PATENTING?

# Count very carefully where we even have zeros and how many they are
 
```{r, fig.height = 15, fig.width = 15, echo=FALSE}
## libraries

suppressWarnings(suppressMessages(library(knitr)))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(kableExtra)))
suppressWarnings(suppressMessages(library(patchwork)))
suppressWarnings(suppressMessages(library(gets)))
suppressWarnings(suppressMessages(library(getspanel)))
suppressWarnings(suppressMessages(library(here)))
suppressWarnings(suppressMessages(library(doParallel)))
suppressWarnings(suppressMessages(library(gdata)))
suppressWarnings(suppressMessages(library(gridExtra)))

# Load plotting functions
source(".\\plotting_functions.R")

# Data
top_25 <- c("JPN", "USA", "KOR", "DEU", "CHN", "FRA", "GBR", "TWN", "CAN", "ITA", "DNK", "NLD", "IND", "AUT", "CHE", "SWE", "ESP", "AUS", "ISR", "BEL", "FIN", "RUS", "NOR", "SGP", "BRA")

df <- read_csv(".\\data\\patents_panel_5techs.csv", show_col_types = F)  %>% filter(ISO %in% top_25)

df %>% 
  group_by(ISO, year, tech) %>% 
  filter(count == 0) %>% 
  count(count) %>% 
  ggplot(aes(x = year, y = n, fill = tech)) +
  geom_col() +
  facet_wrap(~ISO, scales = "fixed") +
  scale_x_continuous(breaks = c(1995, 1997, 1999, 2001, 2003, 2005, 2007, 2009, 2011, 2013,2015, 2017, 2019))+
  theme_bw()+
  theme(legend.position = "bottom") + 
  ggtitle("Count of zeros by country and technology", subtitle = "Australia and Japan have no zeros.")



```

qua aggiungi tabella con i count degli zero by country 

# Plot the distributions before and after logging -> do they look more normal? (also by country in the relevant country sample) {.tabset}

## Count {.tabset}

```{r, echo=FALSE, fig.width=15, fig.height=15}

suppressWarnings(suppressMessages(library(ggridges)))

count <- df %>% 
  mutate(tech = ifelse(tech == "Climate change mitigation technologies related to energy generation, transmission or distribution", "Energy", tech),
         tech = ifelse(tech == "Climate change mitigation", "Green tech", tech)) %>% 
  ggplot(aes(x = count, y = tech, fill = tech)) +
  geom_density_ridges() +
 facet_wrap(~ISO, scales = "free_x") +  
  theme_ridges() + 
  ylab("") + xlab("") +
  theme(legend.position = "none")

suppressMessages(print(count))

```



## Log (y+1) {.tabset}

```{r, echo=FALSE, fig.width=15, fig.height=15}

log <- df %>% 
  mutate(tech = ifelse(tech == "Climate change mitigation technologies related to energy generation, transmission or distribution", "Energy", tech),
         tech = ifelse(tech == "Climate change mitigation", "Green tech", tech)) %>% 
  ggplot(aes(x = log(count+1), y = tech, fill = tech)) +
  geom_density_ridges() +
 facet_wrap(~ISO, scales = "free_x") +  
  theme_ridges() +
  ylab("") + xlab("") +
  theme(legend.position = "none") 

suppressMessages(print(log))

```


## Normalization with the max {.tabset} 

```{r}

# Try to instead of logging normalize the patent count with the patent max (not convinced of this but worth a try for comparison)

```


# What is the relation from 1 patent to the max patents per country?

# Models comparison {.tabset}

 * Y: Levels, Logs+1, **IHS**
 * Controls: gdp, pop
 * AR 1
 * IIS=ON
 * p-val = 0.01, 0.05
 * Sample: top_25

## Green technologies {.tabset}

```{r ccmt, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

ccmt_ihs <- readRDS(".\\ccmt_24_01_ihs.RDS")

ccmt <- readRDS(".\\ccmt_09_01_24_sample_exp.RDS") %>% 
  rbind(ccmt_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

ccmt %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```



## ENERGY {.tabset}

```{r energy, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

energy_ihs <- readRDS(".\\energy_24_01_ihs.RDS")

energy <- readRDS(".\\energy_09_01_24_sample_exp.RDS") %>% 
  rbind(energy_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

energy %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```


## Solar {.tabset}

```{r solar, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

solar_ihs <- readRDS(".\\solar_24_01_ihs.RDS")

solar <- readRDS(".\\solar_09_01_24_sample_exp.RDS") %>% 
  rbind(solar_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

solar %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```


## Wind {.tabset}

```{r wind, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

wind_ihs <- readRDS(".\\wind_24_01_ihs.RDS")

wind <- readRDS(".\\wind_09_01_24_sample_exp.RDS") %>% 
  rbind(wind_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

wind %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```


## Batteries {.tabset}

```{r batteries, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

batteries_ihs <- readRDS(".\\batteries_24_01_ihs.RDS")

batteries <- readRDS(".\\batteries_09_01_24_sample_exp.RDS") %>% 
  rbind(batteries_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

batteries %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```