---
title: "sample_experiments_01"
author: "Laura Menicacci"
date: "2024-01-02"
output: html_document
---

# Experiments with country samples

SUMMARY: 

Initial preliminary experiment with a sample of 21 countries, chosen using a bit of a cumbersome criteria: for each distribution of the combination country and technology, if its 25th quantile falls below the 30th quantile of the overall distribution of patent counts, then that country is excluded from the analysis.

In the meantime, we understood many things:

 * We don't want to differentiate sample by technology
 * If our sample is small, but it covers the majority (at least 90%) of our whole sample, then we're good

Here I present 3 much simpler alternatives: 

 1. Top 25 patenting countries by mean: aggregate all technologies, take mean of patents for each country, sort in descending order and select only the top 25. **These 25 countries already cover roughly 97% of total patenting**. It is a similar sample than the old one, meaning it leads to similar fit. It includes most European countries, US, Japan, China & Taiwan, + a couple of BRICS countries: Brasil, Russia, Singapore, India. 
 
 2. Top 50 patenting countries by mean: aggregate all technologies, take mean patent count for each country, sort in descending order and select the top 50. These 50 countries **cover basically the whole dataset: more than 99% of total patents**. This is a larger and more generous choice, which includes also the least patenting countries (e.g. 50th country has a mean patent count of 2.0032846). 
 
 3. OECD countries + China & Taiwan: 38 + 2 = 40 countries. Different aggregation, plus China and Taiwan which still are top patenting countries and should be included in my opinion. This sample choice **covers 94% of total patents**, which is less than any of the other options. This represents a 'middle' way to go between a strict and large sample choice in terms of geographical coverage. 
List of countries included in this sample: AUSTRALIA, AUSTRIA, BELGIUM, CANADA, CHILE, COLOMBIA, COSTA RICA, CZECH REPUBLIC, DENMARK, ESTONIA, FINLAND, FRANCE, GERMANY, GREECE, HUNGARY, ICELAND, IRELAND, ISRAEL, ITALY, JAPAN, KOREA, LATVIA, LITHUANIA, LUXEMBOURG, MEXICO, NETHERLANDS, NEW ZEALAND, NORWAY, POLAND, PORTUGAL, SLOVAK REPUBLIC, SLOVENIA, SPAIN, SWEDEN, SWITZERLAND, TÃœRKIYE, UNITED KINGDOM, UNITED STATES 

Here you have a decreasing list of mean patent counts for each country of the dataset, you can use it to have a look at which countries are included in the top 25 and top 50 samples:

```{r setup, echo=FALSE}

knitr::opts_chunk$set(echo = TRUE)

## libraries

suppressWarnings(suppressMessages(library(knitr)))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(kableExtra)))
suppressWarnings(suppressMessages(library(patchwork)))
suppressWarnings(suppressMessages(library(gets)))
suppressWarnings(suppressMessages(library(getspanel)))
suppressWarnings(suppressMessages(library(here)))
suppressWarnings(suppressMessages(library(doParallel)))
suppressWarnings(suppressMessages(library(gdata)))
suppressWarnings(suppressMessages(library(gridExtra)))

# Load plotting functions
source(".\\plotting_functions.R")

#techs <- c("Wind energy", "Solar thermal energy","Solar photovoltaic (PV) energy", "Solar thermal-PV hybrids", "Batteries", "Climate change mitigation technologies related to energy generation, transmission or distribution", "Climate change mitigation")

df <- read_csv(".\\data\\patents_panel_5techs.csv", show_col_types = F) # this is the dataset with only the 5 technologies of interest for our study, 1995-2020, full country sample (196)

#df_all <- read_csv(".\\data\\PAT_DEV_05112023163538234.csv", show_col_types = F) %>% select(COU, `Technology domain`, Year, Value) %>% filter(Year > 1994) # this is the dataset with all the Y02 technologies, 1995-2020, full country sample (211)

mean_pat <- df %>% # sort top patenting countries by mean
  group_by(ISO) %>% 
  summarise(mean = mean(count, na.rm=TRUE), .groups = "keep") %>% 
  arrange(desc(mean)) %>% 
  ungroup() %>% 
  mutate(rank = row_number())

mean_pat %>% 
  kable(format = "html") %>% 
  kable_styling(bootstrap_options = c("hover", "responsive"), full_width = F, fixed_thead = T, position = "left") %>% 
  scroll_box(width = "300px", height = "300px")

```

# Difference in coverage of total patents

```{r, echo=FALSE, fig.width=10, fig.height=10}

top_25 <- mean_pat %>% # select top 25 patenting countries
  head(25) %>%  
  pull(ISO) %>% 
  unique()
  
dat_filt <- df %>% filter(ISO %in% top_25)  # filter main df by the top 25 patenting countries and aggregate counts by year (I have total counts by year)

plot_25 <- df %>% # plot difference between whole dataset and top 25 patenting countries
  ggplot(aes(x = count, fill = "all (binwidth = 1000)")) +
  geom_histogram(binwidth = 1000) +
  geom_histogram(data = dat_filt, aes(x = count, fill = "top_25 (binwidth = 1000)"), binwidth = 1000) +
  #scale_y_continuous(limits = c(0,3000)) +
  theme_bw() +
  xlab("patents") +
  ggtitle("Top 25 countries by mean count")
  
###############

top_50 <- mean_pat %>% # select top 50 patenting countries
  head(50) %>%  
  pull(ISO) %>% 
  unique()
  
dat_filt <- df %>% filter(ISO %in% top_50) # filter main df by the top 50 patenting countries and aggregate counts by year (I have total counts by year)

plot_50 <- df %>% # plot difference between whole dataset and top 50 patenting countries
  ggplot(aes(x = count, fill = "all (binwidth = 1000)")) +
  geom_histogram(binwidth = 1000) +
  geom_histogram(data = dat_filt, aes(x = count, fill = "top_50 (binwidth = 1000)"), binwidth = 1000) +
  #scale_y_continuous(limits = c(0,3000)) +
  theme_bw() +
  xlab("patents") +
  ggtitle("Top 50 countries by mean count")
  
####################

oecd <- c("AUS",  "AUT",  "BEL", "CAN", "CHL", "COL", "CRI", "CZE", "DNK", "EST", "FIN", "FRA", "DEU", "GRC", "HUN", "ISL", "IRL", "ISR", "ITA", "JPN", "KOR", "LVA", "LTU", "LUX", "MEX", "NLD", "NZL", "NOR", "POL", "PRT", "SVK", "SVN", "ESP", "SWE", "CHE", "TUR", " GBR", "USA", "CHN", "TWN")

dat_filt <- df %>% filter(ISO %in% oecd)  # filter main df by oecd patenting countries

oecd_plot <- df %>% # plot difference between whole dataset and oecd patenting countries
  ggplot(aes(x = count, fill = "all (binwidth = 1000)")) +
  geom_histogram(binwidth = 1000) +
  geom_histogram(data = dat_filt, aes(x = count, fill = "oecd (binwidth = 1000)"), binwidth = 1000) +
  #scale_y_continuous(limits = c(0,3000)) +
  #scale_x_continuous(limits = c(0,5000)) +
  theme_bw() +
  xlab("patents") +
  ggtitle("OECD countries + CHINA & TAIWAN")

plot_25 / plot_50 / oecd_plot
  
```


# Percentage in coverage

```{r, echo=FALSE}
## percentage of coverage 

top_25_total <- df %>% filter(ISO %in% top_25) %>% summarise(count_top25 = sum(count))
top_50_total <- df %>% filter(ISO %in% top_50) %>% summarise(count_top50 = sum(count))
oecd_total <- df %>% filter(ISO %in% oecd) %>% summarise(count_oecd = sum(count))

df %>% 
  summarise(tot_count = sum(count)) %>% 
  mutate(count_oecd = oecd_total$count_oecd, count_top25 = top_25_total$count_top25, count_top50 = top_50_total$count_top50) %>% 
  mutate(perc_coverage_oecd = (100 * count_oecd) / tot_count, 
         perc_coverage_top25 = (100 * count_top25) / tot_count, 
         perc_coverage_top50 = (100 * count_top50) / tot_count) %>% 
  kable(format = "html") %>% 
  kable_minimal()
```

```{r, echo=FALSE}

# Model prep

## samples 

samples <- mget(c("top_25", "top_50", "oecd"))

## logs 

df_mod <- df %>% 
  filter(year < 2020) %>% 
  mutate(lpop = log(pop), # log pop
         lgdp = log(gdp), # log gdp
         lgdp_sq = log(gdp)^2, # squared gdp
         log_count = log(count+1)) # log transformation

#df_mod %>% pull(ISO) %>% unique 

#df_mod %>% filter(!complete.cases(.)) # sanity check

## formulas

controls <- c("~ gdp + pop", "~ lgdp + lpop") # specify controls

dep_var <- c("count", "log_count") # specify dependent var  

base_forms <- paste0(dep_var, controls) # paste together

```

# Sample experiments with preferred model specification {.tabset}

 * Y: Levels, Logs+1
 * Controls: gdp, pop
 * AR 1
 * IIS=ON
 * p-val = 0.01, 0.05
 * 3 samples: top_25, top_50, oecd

## CCMT {.tabset}

```{r ccmt, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

#cl <- makeCluster(3) 
#registerDoParallel(cl)
#
#models <- foreach(f = base_forms, .combine = rbind, .packages = c('tidyverse', #'getspanel')) %:% # specify functional form 
#  foreach(smpl = c("top_25", "top_50", "oecd"), .combine = rbind) %:% # specify #samples
#  foreach(a = c(1), .combine = rbind) %:%
#  foreach(p.value = c(0.01, 0.05), .combine = rbind, .errorhandling = "remove") #%dopar% {
#    dat <- df_mod %>% filter(tech == "Climate change mitigation") %>% filter(ISO %in% #samples[[smpl]])
#      is <- isatpanel( # main function
#            data = dat,
#            formula = as.formula(f),
#            index = c("ISO", "year"), # id and time
#            effect = "twoways", # twoway fixed effects chosen as estimator
#            iis = TRUE, # enable impulse indicator saturation
#            fesis = TRUE, # enable fixed effects indicator saturation
#            ar = a, # specify auto-regressive terms
#            t.pval = p.value,  # false positive rate
#            max.block.size = 20 # size for block search 
#            )
#          models = tibble(source = f, 
#                          id_sample = smpl,    # sample 
#                          year_range = paste0(min(dat$year),":",max(dat$year)),
#                          p_val = p.value, # false positive rates 
#                          is = list(is), # model
#                          iis = TRUE, # IIS
#                          b_size = 20,
#                          ar = a)
#  }
#
#stopCluster(cl) # stop parallelizing 
#
#saveRDS(models, ".\\ccmt_09_01_24_sample_exp.RDS")  # save model output 

# plot 

ccmt <- readRDS(".\\ccmt_09_01_24_sample_exp.RDS") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

ccmt %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```

## ENERGY {.tabset}

```{r energy, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

energy <- readRDS(".\\energy_09_01_24_sample_exp.RDS") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

energy %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```

## SOLAR {.tabset}

```{r solar, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

solar <- readRDS(".\\solar_09_01_24_sample_exp.RDS") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

solar %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```

## WIND {.tabset}

```{r wind, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

wind <- readRDS(".\\wind_09_01_24_sample_exp.RDS") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

wind %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```

## BATTERIES {.tabset}

```{r batteries, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

batteries <- readRDS(".\\batteries_09_01_24_sample_exp.RDS") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

batteries %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```
