---
title: "overview_results"
author: "Laura Menicacci"
date: "2024-01-26"
output: html_document
---

# Count very carefully where we even have zeros and how many they are
 
```{r, fig.height = 15, fig.width = 15, echo=FALSE}
## libraries

suppressWarnings(suppressMessages(library(knitr)))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(kableExtra)))
suppressWarnings(suppressMessages(library(patchwork)))
suppressWarnings(suppressMessages(library(gets)))
suppressWarnings(suppressMessages(library(getspanel)))
suppressWarnings(suppressMessages(library(here)))
suppressWarnings(suppressMessages(library(doParallel)))
suppressWarnings(suppressMessages(library(gdata)))
suppressWarnings(suppressMessages(library(gridExtra)))
suppressWarnings(suppressMessages(library(ggridges)))

# Load plotting functions
source(".\\plotting_functions.R")

# Data
top_25 <- c("JPN", "USA", "KOR", "DEU", "CHN", "FRA", "GBR", "TWN", "CAN", "ITA", "DNK", "NLD", "IND", "AUT", "CHE", "SWE", "ESP", "AUS", "ISR", "BEL", "FIN", "RUS", "NOR", "SGP", "BRA")

df <- read_csv(".\\data\\patents_panel_5techs.csv", show_col_types = F)  %>% filter(ISO %in% top_25)

df %>% 
  group_by(ISO, year, tech) %>% 
  filter(count == 0) %>% 
  count(count) %>% 
  ggplot(aes(x = year, y = n, fill = tech)) +
  geom_col() +
  facet_wrap(~ISO, scales = "fixed") +
  scale_x_continuous(breaks = c(1995, 1997, 1999, 2001, 2003, 2005, 2007, 2009, 2011, 2013, 2015, 2017, 2019))+
  theme_bw()+
  theme(legend.position = "bottom") + 
  ggtitle("Count of zeros by country and technology", subtitle = "Australia and Japan have no zeros.")



```

## Table format 

Number of zero counts by country, in descending order. 

```{r, echo=FALSE}

df %>% 
  group_by(ISO) %>% 
  filter(count == 0) %>% 
  count(count) %>% 
  select(ISO, n) %>% 
  arrange(desc(n)) %>% 
  kable(format = "html") #%>% 
  #kable_styling(bootstrap_options = c("hover", "responsive"), full_width = F, fixed_thead = T, position = "left") %>% 
  #scroll_box(width = "300px", height = "300px")

```


# Plot the distributions before and after logging -> do they look more normal? {.tabset}

## Count {.tabset}

```{r, echo=FALSE, fig.width=15, fig.height=15}

count <- df %>% 
  mutate(tech = ifelse(tech == "Climate change mitigation technologies related to energy generation, transmission or distribution", "Energy", tech),
         tech = ifelse(tech == "Climate change mitigation", "Green tech", tech)) %>% 
  ggplot(aes(x = count, y = tech, fill = tech)) +
  geom_density_ridges() +
 facet_wrap(~ISO, scales = "free_x") +  
  theme_ridges() + 
  ylab("") + xlab("") +
  theme(legend.position = "none")

suppressMessages(print(count))

```



## Log (y+1) {.tabset}

```{r, echo=FALSE, fig.width=15, fig.height=15}

log <- df %>% 
  mutate(tech = ifelse(tech == "Climate change mitigation technologies related to energy generation, transmission or distribution", "Energy", tech),
         tech = ifelse(tech == "Climate change mitigation", "Green tech", tech)) %>% 
  ggplot(aes(x = log(count+1), y = tech, fill = tech)) +
  geom_density_ridges() +
 facet_wrap(~ISO, scales = "free_x") +  
  theme_ridges() +
  ylab("") + xlab("") +
  theme(legend.position = "none") 

suppressMessages(print(log))

```


## Normalization with the max {.tabset} 

```{r, echo=FALSE, fig.width=15, fig.height=15}

# Try to instead of logging normalize the patent count with the patent max (not convinced of this but worth a try for comparison)

max_norm <- df %>% 
  mutate(max_norm_count = count / max(count)) %>% 
  mutate(tech = ifelse(tech == "Climate change mitigation technologies related to energy generation, transmission or distribution", "Energy", tech),
         tech = ifelse(tech == "Climate change mitigation", "Green tech", tech)) %>% 
  ggplot(aes(x = max_norm_count, y = tech, fill = tech)) +
  geom_density_ridges() +
  facet_wrap(~ISO, scales = "free_x") +  
  theme_ridges() +
  ylab("") + xlab("") +
  theme(legend.position = "none") 

suppressMessages(print(max_norm))

```


## Normalization with the max by technology {.tabset} 

Normalise by max but with respect to the max of each technology.

```{r, echo=FALSE, fig.width=15, fig.height=15}

max_norm_tech <- df %>% 
  group_by(tech) %>% # what if we   
  mutate(max_norm_count = count / max(count)) %>% 
  mutate(tech = ifelse(tech == "Climate change mitigation technologies related to energy generation, transmission or distribution", "Energy", tech),
         tech = ifelse(tech == "Climate change mitigation", "Green tech", tech)) %>% 
  ggplot(aes(x = max_norm_count, y = tech, fill = tech)) +
  geom_density_ridges() +
  facet_wrap(~ISO, scales = "free_x") +  
  theme_ridges() +
  ylab("") + xlab("") +
  theme(legend.position = "none") 

suppressMessages(print(max_norm_tech))

```

# What is the relation from 1 patent to the max patents per country? 

```{r, echo=FALSE, fig.width=15, fig.height=15}

df %>% 
  group_by(ISO, tech) %>% 
  mutate(max = max(count)) %>% 
  ggplot(aes(x = count, y = max, colour = tech)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", colour = "darkgrey") + 
  facet_wrap(~ISO, scales = "free") +  
  labs(title = "Relationship between Y and max Y per country",
       x = "Y",
       y = "Max Y per country") +
  theme_bw()+
  theme(legend.position = "bottom")

```


# Models comparison {.tabset}

 * Y: Levels, Logs+1, **IHS**
 * Controls: gdp, pop
 * AR 1
 * IIS=ON
 * p-val = 0.01, 0.05
 * Sample: top_25

## Green technologies {.tabset}

```{r ccmt, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

ccmt_ihs <- readRDS(".\\ccmt_24_01_ihs.RDS")

ccmt <- readRDS(".\\ccmt_09_01_24_sample_exp.RDS") %>% 
  rbind(ccmt_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

ccmt %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```



## Energy {.tabset}

```{r energy, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

energy_ihs <- readRDS(".\\energy_24_01_ihs.RDS")

energy <- readRDS(".\\energy_09_01_24_sample_exp.RDS") %>% 
  rbind(energy_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

energy %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```


## Solar {.tabset}

```{r solar, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

solar_ihs <- readRDS(".\\solar_24_01_ihs.RDS")

solar <- readRDS(".\\solar_09_01_24_sample_exp.RDS") %>% 
  rbind(solar_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

solar %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```


## Wind {.tabset}

```{r wind, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

wind_ihs <- readRDS(".\\wind_24_01_ihs.RDS")

wind <- readRDS(".\\wind_09_01_24_sample_exp.RDS") %>% 
  rbind(wind_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

wind %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```


## Batteries {.tabset}

```{r batteries, echo=FALSE, results = 'asis', fig.height=30, fig.width=55, cache = TRUE}

# plot 

batteries_ihs <- readRDS(".\\batteries_24_01_ihs.RDS")

batteries <- readRDS(".\\batteries_09_01_24_sample_exp.RDS") %>% 
  rbind(batteries_ihs) %>% 
  filter(id_sample == "top_25") %>% 
  separate(source, into = c("dep","formula"), sep = "[~]", remove = FALSE) %>%
  mutate(dep = str_to_title(gsub("_"," ",trimws(dep))),
         formula = trimws(formula))

batteries %>%
       dplyr::group_split(id_sample) %>%
       purrr::iwalk(.,~{
         name <- unique(.x$id_sample)
         cat('### ', name, '{.tabset}   \n')
              for(p in unique(.x$dep)){
                   cat('#### ', p, '{.tabset}   \n')
                for(sm in unique(.x$p_val)){
                   cat('##### ', sm, '{.tabset}   \n')
                   filter(.x, p_val == sm & dep == p) %>% gen_p(., auto = TRUE)
                cat('\n')
                cat('\n')
                }
           cat('\n')
           cat('\n')
           }
         cat('\n')
         cat('\n')
       })
       
```